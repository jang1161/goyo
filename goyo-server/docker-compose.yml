version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15
    container_name: goyo_postgres
    environment:
      POSTGRES_USER: goyo_user
      POSTGRES_PASSWORD: goyo_password
      POSTGRES_DB: goyo_db
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - goyo_network

  # Redis Cache & Pub/Sub
  redis:
    image: redis:7-alpine
    container_name: goyo_redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    networks:
      - goyo_network

  # MQTT Broker (Mosquitto)
  mqtt:
    image: eclipse-mosquitto:2
    container_name: goyo_mqtt
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mqtt_data:/mosquitto/data
      - mqtt_logs:/mosquitto/log
    networks:
      - goyo_network

  # FastAPI Backend (Phase 3 완료)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: goyo_backend_server
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://goyo_user:goyo_password@postgres:5432/goyo_db
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MQTT_BROKER_HOST=mqtt
      - MQTT_BROKER_PORT=1883
    depends_on:
      - postgres
      - redis
      - mqtt
    networks:
      - goyo_network
    # volumes:
    #   - ./goyo-backend:/app
    # command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  # AI Server (Phase 3.5 - NEW!)
  ai:
    build:
      context: ./ai
      dockerfile: Dockerfile
    container_name: goyo_ai_server
    ports:
      - "8001:8001"
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MQTT_BROKER_HOST=mqtt
      - MQTT_BROKER_PORT=1883
      - SAMPLE_RATE=44100
      - CHUNK_SIZE=1024
    depends_on:
      - redis
      - mqtt
    networks:
      - goyo_network
    # USB 마이크 접근 (필요 시 활성화)
    # devices:
    #   - /dev/snd:/dev/snd
    # volumes:
    #   - ./goyo-ai-server:/app
    # command: uvicorn main:app --host 0.0.0.0 --port 8001 --reload

volumes:
  postgres_data:
  redis_data:
  mqtt_data:
  mqtt_logs:

networks:
  goyo_network:
    driver: bridge